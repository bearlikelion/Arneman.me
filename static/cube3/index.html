<!doctype html>
<html lang="en" class="h-100">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.0/css/bootstrap.min.css" integrity="sha384-PDle/QlgIONtM1aqA2Qemk5gPOE7wFq8+Em+G/hmo5Iq0CCmYZLv3fVRDJ4MMwEA" crossorigin="anonymous">

    <title>Cube3 High Scores</title>

    <style type="text/css">
        .itchio iframe {
            margin: 0 auto;
            display: block;
        }
        .footer {
          background-color: #f5f5f5;
        }
        body {
            background-image: url("grid.png");
        }
        .container {
            background-color: #f5f5f5;
        }
    </style>
  </head>
  <body class="d-flex flex-column h-100">
    <main role="main" class="flex-shrink-0">
        <div class="container">
            <h1><p class="text-center">Cube3</p></h1>

            <hr />

            <div class="row">
                <div class="col itchio">
                    <div class="d-none d-md-none d-lg-block">
                        <iframe src="https://itch.io/embed/403368?bg_color=ffffff&amp;fg_color=00171f&amp;link_color=007ea7&amp;border_color=333333" width="552" height="167" frameborder="0"></iframe>
                    </div>
                    <div class="d-none d-xs-block d-sm-block d-md-block d-lg-none">
                        <iframe src="https://itch.io/embed/403368?bg_color=ffffff&amp;fg_color=00171f&amp;link_color=007ea7&amp;border_color=333333" width="208" height="167" frameborder="0"></iframe>
                    </div>
                </div>
            </div>

            <hr class="d-none d-lg-block" />

            <div class="row d-none d-lg-block">
                <div class="col">
                    <h2><a id="About_4"></a>About</h2>
                    <p>Cube3 (Cube Cubed) is a game created for 8 Bits to Infinityâ€™s <a href="https://itch.io/jam/2buttonjam">Two Button Jam</a>. The player controls a cube left and right across a grid to avoid oncoming obstacles.</p>
                    <p class="text-center"><strong>Play in your browser or download it <a href="https://bearlikelion.itch.io/cube3">here</a>!</strong></p>
                </div>
            </div>

            <hr class="d-none d-lg-block" />

            <div class="row">
                <div class="col">
                    <h1><p>Leaderboard</p></h1>

                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th class="text-center" scope="col">Position</th>
                          <th class="text-center" scope="col">Score</th>
                          <th class="text-center" scope="col">Time</th>
                        </tr>
                      </thead>
                      <tbody id="records_table">
                      </tbody>
                    </table>

                    <div class="loading d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer mt-auto py-3">
                <div class="container">
                    <div class="row  text-muted">
                        <div class="col text-left">
                            <span>Made by <a href="https://arneman.me" target="_blank">Mark</a></span>
                        </div>
                        <div class="col text-center">
                            <span>Powered by <a href="https://dreamlo.com" target="_blank">Dreamlo.</a></span>
                        </div>
                        <div class="col text-right">
                            <span>Scores from: <span class="timestamp">Fetching Scores...</span></span>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </main>
    <img src="https://stats.arneman.me/anal.php?idsite=2&amp;rec=1" style="border:0" alt="" />

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.min.js" integrity="sha384-7aThvCh9TypR7fIc2HV4O/nFMVCBwyIUKL8XCtKE+8xgCgl/PQGuFsvShjr74PBp" crossorigin="anonymous"></script>
    <script type="text/javascript" src="lscache.min.js"></script>
    <script type="text/javascript" src="thenBy.min.js"></script>

    <script type="text/javascript">
      var _paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//stats.arneman.me/";
        _paq.push(['setTrackerUrl', u+'anal.php']);
        _paq.push(['setSiteId', '2']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'anal.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>

    <script type="text/javascript">
        //<![CDATA[
        var owa_baseUrl = 'http://wa.arneman.me/';
        var owa_cmds = owa_cmds || [];
        owa_cmds.push(['setSiteId', '7939fe2c9a05013cdd0f3ac71d6e3f44']);
        owa_cmds.push(['trackPageView']);
        owa_cmds.push(['trackClicks']);

        (function() {
            var _owa = document.createElement('script'); _owa.type = 'text/javascript'; _owa.async = true;
            owa_baseUrl = ('https:' == document.location.protocol ? window.owa_baseSecUrl || owa_baseUrl.replace(/http:/, 'https:') : owa_baseUrl );
            _owa.src = owa_baseUrl + 'modules/base/js/owanal.js';
            var _owa_s = document.getElementsByTagName('script')[0]; _owa_s.parentNode.insertBefore(_owa, _owa_s);
        }());
        //]]>
    </script>

    <script>
        var url = 'https://www.dreamlo.com/lb/5cae38f63eba5e041cd5d655/json-score-desc';
        // lscache.remove(url); // DEBUG

        function ShowScores(score) {
            $( ".loading" ).remove();
            $(".timestamp").text(lscache.get('timestamp'));
            $.each(score, function(i, item) {
                // console.log(item);
                var $tr = $('<tr>').append(
                    $('<td class="text-center">').text("#" + (i+1)),
                    $('<td class="text-center">').text(item.score),
                    $('<td class="text-center">').text(item.seconds)
                ).appendTo("#records_table");
            });
        }

        if (cachedJson = lscache.get(url)) {
            console.log("Loaded from cache");
            ShowScores(cachedJson);
        } else {
            console.log("Fetch Fresh Scores");
            $.getJSON(url).done(function (data) {
                if (Array.isArray(data.dreamlo.leaderboard.entry)) {
                    scores = data.dreamlo.leaderboard.entry;
                    scores.sort(
                        firstBy(function(v1, v2) { return v2.score - v1.score; })
                        .thenBy(function(v1, v2) { return v2.seconds - v1.seconds; })
                    );

                    console.log(scores);

                    lscache.set(url, scores, 2);
                    lscache.set('timestamp', new Date().toLocaleTimeString(), 2);
                    ShowScores(scores);
                } else {
                    $(".loading").html("<h3>Failed to load High Scores</h3>");
                }
            });
        }
    </script>
  </body>
</html>